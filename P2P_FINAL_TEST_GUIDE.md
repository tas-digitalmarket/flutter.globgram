# 🚀 راهنمای تست کامل P2P Chat

## 🔧 تغییرات انجام شده برای رفع مشکل

### ❌ مشکلات قبلی:
1. **Singleton Pattern**: همه تب‌ها از یک instance استفاده می‌کردند
2. **پیام‌ها به خود فرستنده برمی‌گشت**: به دلیل اشتراک instance
3. **Peer دوم join نمی‌شد**: چون BroadcastChannel share می‌شد

### ✅ راه‌حل‌های پیاده‌سازی شده:
1. **حذف Singleton Pattern** از:
   - `BroadcastSignalingService`
   - `P2PManager` 
   - `WebRTCService`

2. **تصحیح data structure** در chat message handling

3. **بهبود نمایش Room ID** و دکمه کپی

---

## 📋 مراحل تست (مرحله به مرحله)

### مرحله 1: آماده‌سازی
```bash
cd "d:\برنامه نویسی\globgramflutter"
flutter run -d web-server --web-port 8081
```

### مرحله 2: باز کردن تب اول (کاربر A)
1. مرورگر باز کنید: `http://localhost:8081`
2. صفحه اصلی Globgram بارگذاری می‌شود
3. روی **"Create Room"** کلیک کنید
4. Room ID تولید می‌شود (مثل "ABC123")
5. روی **"Copy ID"** کلیک کنید
6. Room ID کپی شد
7. روی **"Join Room"** کلیک کنید
8. وارد صفحه چت می‌شوید

### مرحله 3: باز کردن تب دوم (کاربر B)
1. **تب جدید** باز کنید: `http://localhost:8081`
2. در فیلد "Room Name" همان Room ID را paste کنید
3. روی **"Join Room"** کلیک کنید
4. وارد صفحه چت می‌شوید

### مرحله 4: بررسی اتصال
در هر دو تب باید ببینید:
- **Room ID یکسان**: مثل "ABC123"
- **Peer ID متفاوت**: هر تب شناسه منحصر به فرد دارد
- **وضعیت اتصال**: "Connecting" سپس "Connected"

### مرحله 5: تست ارسال پیام
1. در **تب اول** پیام تایپ کنید: "سلام از کاربر 1"
2. Enter بزنید یا "Send" کلیک کنید
3. **انتظار**: پیام باید فقط در **تب دوم** ظاهر شود
4. در **تب دوم** پاسخ دهید: "سلام از کاربر 2" 
5. **انتظار**: پیام باید فقط در **تب اول** ظاهر شود

---

## 🔍 عیب‌یابی و لاگ‌ها

### مشاهده لاگ‌ها:
1. F12 بزنید (Developer Tools)
2. تب **Console** را باز کنید
3. لاگ‌های اتصال و پیام‌ها را مشاهده کنید

### لاگ‌های مهم:
```
✅ BroadcastSignalingService initialized
📄 Room: ABC123  
📄 Local Peer ID: xyz123
📄 Sending message: "سلام"
✅ Chat message received from xyz456: "سلام"
```

### در صفحه چت:
- روی **"View Logs"** کلیک کنید
- لاگ‌های داخلی اپلیکیشن را مشاهده کنید

---

## ⚠️ مشکلات احتمالی و راه‌حل

### مشکل 1: "Data channel is not open"
**علت**: WebRTC هنوز برقرار نشده
**راه‌حل**: عادی است، پیام‌ها via BroadcastChannel ارسال می‌شوند

### مشکل 2: پیام‌ها ارسال نمی‌شوند
**بررسی کنید**:
- آیا هر دو تب همان Room ID را دارند؟
- آیا Peer ID هر تب متفاوت است؟
- آیا لاگ "Chat message received" ظاهر می‌شود؟

### مشکل 3: پیام به خود کاربر برمی‌گردد
**علت**: ممکن است از همان تب دو بار استفاده کرده باشید
**راه‌حل**: تب‌ها را refresh کنید و دوباره تلاش کنید

---

## ✅ تست موفقیت‌آمیز

اگر همه چیز درست کار می‌کند:

### در تب اول:
```
Room: ABC123
Peer: xyz123
Status: Connected

Messages:
[xyz456]: سلام از کاربر 2
[xyz456]: چطوری؟
```

### در تب دوم:
```
Room: ABC123  
Peer: xyz456
Status: Connected

Messages:
[xyz123]: سلام از کاربر 1
[xyz123]: خوبم تو چطوری؟
```

### نکات مهم:
- هر تب فقط پیام‌های **دیگران** را نشان می‌دهد
- پیام‌های ارسالی خودتان در لیست ظاهر نمی‌شوند (طبیعی است)
- Room ID یکسان، Peer ID متفاوت

---

## 🎯 نتیجه‌گیری

این تست نشان می‌دهد که:
1. ✅ BroadcastChannel درست کار می‌کند
2. ✅ پیام‌ها بین تب‌های مختلف رد و بدل می‌شوند  
3. ✅ هر تب instance مستقل دارد
4. ✅ سیستم P2P محلی بدون سرور کار می‌کند

**نکته**: این برای محیط توسعه است. برای production نیاز به STUN/TURN server دارید.
