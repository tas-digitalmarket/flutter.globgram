# راهنمای تست اتصال P2P واقعی - Globgram Flutter

## مفاهیم مهم

### Room ID vs Peer ID
- **Room ID**: شناسه اتاق که همه کاربران باید برای join کردن از آن استفاده کنند (مثل `ABC123`)
- **Peer ID**: شناسه منحصر به فرد هر کاربر در درون اتاق (مثل `abc12345` و `xyz67890`)

### نحوه کار
1. کاربر اول اتاق ایجاد می‌کند و Room ID دریافت می‌کند
2. کاربر دوم با همان Room ID وارد می‌شود  
3. هر دو کاربر Peer ID منحصر به فرد خودشان را دارند
4. آنها در یک BroadcastChannel مشترک (بر اساس Room ID) ارتباط برقرار می‌کنند

## مرحله‌ی تست

### مرحله ۱: ایجاد اتاق توسط کاربر اول
1. اجرای اپلیکیشن: `flutter run -d chrome --web-port=8081`
2. کلیک روی "Create Room"
3. یادداشت Room ID نمایش داده شده (مثلاً: `ABC123`)
4. کلیک روی "Join Room" برای ورود به اتاق

### مرحله ۲: اتصال کاربر دوم
1. باز کردن تب جدید در مرورگر
2. رفتن به: `http://localhost:8081`
3. وارد کردن همان Room ID (`ABC123`) در فیلد "Enter room ID"
4. کلیک روی "Join Room"

### مرحله ۳: بررسی اتصال
در هر دو تب باید این اطلاعات نمایش داده شود:
- **وضعیت**: "Connected" (سبز)
- **Room**: `ABC123` (یکسان برای هر دو)
- **Your ID**: `abc12345` (متفاوت برای هر کاربر)
- **Connected Peers**: `1 peers`

### مرحله ۴: تست ارسال پیام
1. در تب اول پیامی بنویسید و ارسال کنید
2. پیام باید فوراً در تب دوم نمایش داده شود
3. از تب دوم نیز پیام ارسال کنید
4. تأیید کنید که پیام‌ها در هر دو تب نمایش داده می‌شوند

## ابزارهای عیب‌یابی

### دکمه‌های تست
- **🐛 Test Connection**: بررسی وضعیت اتصال و ارسال پیام تستی
- **📋 Debug Logs**: مشاهده لاگ‌های اتصال در UI

### لاگ‌های مهم در کنسول (F12):
```
✅ BroadcastSignalingService initialized
📄 Room: ABC123
� Local Peer ID: abc12345
🐛 Channel: globgram_room_ABC123
📄 Announcing presence in room ABC123
🐛 Broadcast sent: peer_announcement
� Received broadcast: peer_announcement from xyz67890
� Peer announced: xyz67890 (Flutter User xyz6)
✅ Peer responded: xyz67890 (Flutter User xyz6)
```

## مشکلات متداول و راه‌حل

### مشکل ۱: دکمه Join Room فعال نمی‌شود
- **علت**: Room ID وارد نشده
- **راه‌حل**: مطمئن شوید که Room ID را صحیح وارد کرده‌اید

### مشکل ۲: هیچ peer ای دیده نمی‌شود
- **علت**: Room ID متفاوت در دو تب
- **راه‌حل**: مطمئن شوید که هر دو تب از همان Room ID استفاده می‌کنند

### مشکل ۳: پیام‌ها ارسال نمی‌شوند
- **علت**: اتصال برقرار نشده
- **راه‌حل**: 
  - از دکمه Test Connection استفاده کنید
  - لاگ‌های Debug را بررسی کنید
  - از دکمه Rejoin استفاده کنید

### مشکل ۴: فقط پیام‌های خودم را می‌بینم
- **علت**: peer دیگر واقعاً متصل نشده
- **راه‌حل**: 
  - مطمئن شوید که وضعیت "Connected" باشد
  - تعداد Connected Peers بیشتر از 0 باشد
  - Room ID در هر دو تب یکسان باشد

## نکات تکنیکی

### BroadcastChannel
- فقط بین تب‌های همان مرورگر کار می‌کند
- نیاز به Domain و Port یکسان دارد
- Real-time و بدون نیاز به سرور

### ساختار پیام‌های Signaling:
```json
{
  "type": "peer_announcement",
  "from": "abc12345",
  "peer_name": "Flutter User abc1",
  "room_id": "ABC123",
  "timestamp": "2025-07-05T10:30:00.000Z"
}
```

## توسعه آینده
- پشتیبانی از دستگاه‌های مختلف با WebSocket signaling
- بهبود امنیت و رمزنگاری پیام‌ها  
- اضافه کردن قابلیت‌های صوتی و تصویری
- پشتیبانی از Group Chat با multiple peers
